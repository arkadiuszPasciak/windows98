import { Meta, Title } from "@storybook/addon-docs/blocks";

<Meta title="CI-CD/Architecture" />

<Title>🏗️ Architecture</Title>

The CI/CD workspace implements a command orchestration architecture that efficiently manages automation tasks across the entire Windows98 monorepo through centralized command execution and selective workspace targeting.

## Overview

```
┌─────────────────────────────────────────────────────────────┐
│                @windows98/ci-cd                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │    Commands     │  │     Configs     │                   │
│  │                 │  │                 │                   │
│  │ • run.command   │  │ • ci-cd.config  │                   │
│  │   Entry Point   │  │   Workspace     │                   │
│  │                 │  │   Definitions   │                   │
│  └─────────────────┘  └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│                 Command Execution                           │
├─────────────────────────────────────────────────────────────┤
│  build           → @windows98/app                           │
│  lint:code:run   → app, configs, design-system, docs...     │
│  lint:staged:fix → app, configs, design-system, docs...     │
│  lint:styles:run → app, design-system, micro-frontends      │
│  lint:types:run  → app, design-system, docs, i18n...        │
│  test:ui:run     → design-system, micro-frontends           │
│  test:unit:run   → app, design-system, micro-frontends...   │
└─────────────────────────────────────────────────────────────┘
```

## Component Structure

### **Commands Layer** (`src/commands/`)
- **`run.command.mjs`** - Entry point for all CI/CD operations
- Extracts command arguments from CLI
- Instantiates and executes CICDCommand class

### **Configuration Layer** (`src/configs/`)
- **`ci-cd.config.mjs`** - Central configuration defining workspace mappings
- Contains CICDCommand class with command execution logic
- Maps each command type to relevant workspace packages

## Execution Flow

### **Command Input**
- Developer runs `pnpm [command]` from CI/CD workspace
### **Argument Parsing**
- `run.command.mjs` extracts command type from CLI args
### **Configuration Lookup**
- CICDCommand retrieves workspace list for command
### **Sequential Execution**
- Commands run across each target workspace using PNPM filters
### **Error Handling**
- Robust error reporting with command and workspace context
### **Completion**
- Success/failure feedback with detailed logging

## Workspace Targeting Strategy

Each command type targets only relevant workspaces to optimize performance and avoid unnecessary operations:

### **Build Operations**
- `build` → Only packages that produce deployable artifacts

### **Code Quality Operations**
- `lint:code:run` → All packages with TypeScript/JavaScript code
- `lint:staged:fix` → All packages for pre-commit hooks
- `lint:styles:run` → Only packages with CSS/styling
- `lint:types:run` → All packages with TypeScript definitions

### **Testing Operations**
- `test:ui:run` → Only packages with UI components requiring browser testing
- `test:unit:run` → All packages with testable business logic

## Performance Optimizations

- **Selective Targeting**: Commands only run on relevant workspaces
- **PNPM Integration**: Leverages PNPM's workspace filtering for efficient execution
- **Error Isolation**: Failed commands in one workspace don't block others
- **Sequential Processing**: Controlled execution prevents resource conflicts
